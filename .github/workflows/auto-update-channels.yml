name: è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨

on:
  schedule:
    - cron: '0 22 * * *'
    - cron: '0 8 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: 
      - 'Parser/**'
      - '.github/workflows/**'

jobs:
  update-channels:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./Parser
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install requests beautifulsoup4 lxml
        fi
    
    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
    
    - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        for file in LiveChannel.txt modular_batch_processor.py searcher_interface.py tonkiang_searcher.py run_processor.py; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘æ–‡ä»¶: $file"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file"
          fi
        done
    
    - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
      run: |
        if [ -f result.txt ]; then
          cp result.txt result_backup.txt
          echo "âœ… å·²å¤‡ä»½ result.txt"
        else
          echo "â„¹ï¸ result.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
        fi
    
    - name: æ‰§è¡Œé¢‘é“æœç´¢
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œé¢‘é“æœç´¢..."
        echo "å¼€å§‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        timeout 5400 python run_processor.py
        echo "âœ… æœç´¢å®Œæˆ"
    
    - name: æ£€æŸ¥ç»“æœæ–‡ä»¶
      id: check_result
      run: |
        if [ ! -f result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        if [ ! -s result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        line_count=$(wc -l < result.txt)
        file_size=$(du -h result.txt | cut -f1)
        group_count=$(grep -c "^[^,]*,$" result.txt || echo "0")
        echo "ğŸ“Š ç»“æœç»Ÿè®¡: è¡Œæ•°=$line_count, å¤§å°=$file_size, åˆ†ç»„=$group_count"
        echo "line_count=$line_count" >> $GITHUB_OUTPUT
        echo "file_size=$file_size" >> $GITHUB_OUTPUT
        echo "group_count=$group_count" >> $GITHUB_OUTPUT
    
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      run: |
        has_changes="false"
        if [ ! -f result_backup.txt ]; then
          echo "â„¹ï¸ é¦–æ¬¡è¿è¡Œ"
          has_changes="true"
        else
          if ! cmp -s result.txt result_backup.txt; then
            echo "ğŸ”„ æ–‡ä»¶æœ‰å˜åŒ–"
            has_changes="true"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–"
          fi
        fi
        echo "has_changes=$has_changes" >> $GITHUB_OUTPUT
    
    - name: é…ç½®Git
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: æäº¤æ›´æ–°
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        cd ..
        git add Parser/result.txt
        current_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - $current_time" -m "é¢‘é“åˆ†ç»„: ${{ steps.check_result.outputs.group_count }} ä¸ª" -m "æ€»é“¾æ¥æ•°: ${{ steps.check_result.outputs.line_count }} è¡Œ" -m "æ–‡ä»¶å¤§å°: ${{ steps.check_result.outputs.file_size }}"
        git push
        echo "âœ… æ›´æ–°å·²æäº¤"

env:
  PYTHONIOENCODING: utf-8
  PYTHONUNBUFFERED: 1
