name: è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨

on:
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤©22:00 UTCæ‰§è¡Œ
    - cron: '0 8 * * *'   # æ¯å¤©08:00 UTCæ‰§è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # å…è®¸æ¨é€åˆ°ä»“åº“
      actions: read      # å…è®¸è¯»å–actions
    defaults:
      run:
        working-directory: ./Parser
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    

    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install requests beautifulsoup4 lxml
        fi
    
    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        python --version
        ls -la
    
    - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        for file in LiveChannel.txt modular_batch_processor.py searcher_interface.py tonkiang_searcher.py run_processor.py; do
          [ -f "$file" ] || exit 1
        done
    
    - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
      run: |
        [ -f result.txt ] && cp result.txt result_backup.txt || true
    
    - name: æ‰§è¡Œé¢‘é“æœç´¢
      run: |
        export SEARCH_DELAY=5
        export MAX_WORKERS=1
        export RETRY_DELAY=20
        timeout 1800 python run_processor.py
    
    - name: æ£€æŸ¥ç»“æœæ–‡ä»¶å¹¶éªŒè¯è´¨é‡
      id: check_result
      run: |
        [ -f result.txt ] && [ -s result.txt ] || exit 1
        
        # ä¿®å¤æ•°å­—æ ¼å¼é—®é¢˜ï¼Œç¡®ä¿è¾“å‡ºæ˜¯çº¯æ•°å­—
        valid_channel_count=$(grep -v "^[^,]*,$" result.txt 2>/dev/null | wc -l | tr -d ' \n' || echo "0")
        group_count=$(grep -c "^[^,]*,$" result.txt 2>/dev/null | tr -d ' \n' || echo "0")
        
        # ç¡®ä¿å˜é‡æ˜¯æœ‰æ•ˆçš„æ•°å­—
        valid_channel_count=${valid_channel_count:-0}
        group_count=${group_count:-0}
        
        # è°ƒè¯•è¾“å‡º
        echo "æ£€æµ‹åˆ°çš„é¢‘é“æ•°: '$valid_channel_count'"
        echo "æ£€æµ‹åˆ°çš„åˆ†ç»„æ•°: '$group_count'"
        
        # æ•°å­—éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºçº¯æ•°å­—
        if ! [[ "$valid_channel_count" =~ ^[0-9]+$ ]]; then
          echo "é”™è¯¯ï¼šé¢‘é“è®¡æ•°ä¸æ˜¯æœ‰æ•ˆæ•°å­—: $valid_channel_count"
          valid_channel_count=0
        fi
        
        if ! [[ "$group_count" =~ ^[0-9]+$ ]]; then
          echo "é”™è¯¯ï¼šåˆ†ç»„è®¡æ•°ä¸æ˜¯æœ‰æ•ˆæ•°å­—: $group_count"
          group_count=0
        fi
        
        # è´¨é‡æ£€æŸ¥
        if [ "$valid_channel_count" -lt 10 ]; then
          echo "æ£€æŸ¥å¤±è´¥: é¢‘é“æ•°=$valid_channel_count (éœ€è¦â‰¥10)"
          echo "QUALITY_CHECK=false" >> $GITHUB_ENV
          exit 0
        fi
        
        echo "æ£€æŸ¥é€šè¿‡: é¢‘é“æ•°=$valid_channel_count, åˆ†ç»„æ•°=$group_count"
        echo "QUALITY_CHECK=true" >> $GITHUB_ENV
        echo "VALID_CHANNELS=$valid_channel_count" >> $GITHUB_ENV
        echo "GROUPS=$group_count" >> $GITHUB_ENV
    
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      if: env.QUALITY_CHECK == 'true'
      run: |
        if [ ! -f result_backup.txt ] || ! cmp -s result.txt result_backup.txt; then
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        else
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        fi
    
    - name: é…ç½®Git
      if: env.QUALITY_CHECK == 'true' && env.HAS_CHANGES == 'true'
      run: |
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
    
    - name: æäº¤æ›´æ–°
      if: env.QUALITY_CHECK == 'true' && env.HAS_CHANGES == 'true'
      run: |
        git add result.txt
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - ${{ env.VALID_CHANNELS }}ä¸ªé¢‘é“ï¼Œ${{ env.GROUPS }}ä¸ªåˆ†ç»„"
        git push
    
    - name: è´¨é‡æ£€æŸ¥å¤±è´¥å¤„ç†
      if: env.QUALITY_CHECK == 'false'
      run: |
        echo "è´¨é‡æ£€æŸ¥æœªé€šè¿‡ï¼Œè·³è¿‡æäº¤"
        exit 0

env:
  PYTHONIOENCODING: utf-8
  PYTHONUNBUFFERED: 1
