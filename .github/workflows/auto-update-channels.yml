name: è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨

on:
  schedule:
    - cron: '0 22 * * *'  # æ¯å¤©22:00 UTCæ‰§è¡Œ
    - cron: '0 8 * * *'   # æ¯å¤©08:00 UTCæ‰§è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # å…è®¸æ¨é€åˆ°ä»“åº“
      actions: read      # å…è®¸è¯»å–actions
    defaults:
      run:
        working-directory: ./Parser
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–åŒ…
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install requests beautifulsoup4 lxml
        fi
    
    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
    
    - name: æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        for file in LiveChannel.txt modular_batch_processor.py searcher_interface.py tonkiang_searcher.py run_processor.py; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘æ–‡ä»¶: $file"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file"
          fi
        done
    
    - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
      run: |
        if [ -f result.txt ]; then
          cp result.txt result_backup.txt
          echo "âœ… å·²å¤‡ä»½ result.txt"
        else
          echo "â„¹ï¸ result.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
        fi
    
    - name: æ‰§è¡Œé¢‘é“æœç´¢
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œé¢‘é“æœç´¢..."
        echo "å¼€å§‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "GitHub Runner IPä¿¡æ¯:"
        curl -s https://httpbin.org/ip || echo "æ— æ³•è·å–IPä¿¡æ¯"
        echo ""
        
        # ç®€å•ç²—æš´ï¼šç›´æ¥å°è¯•æœç´¢ï¼Œå¤±è´¥å°±å¤±è´¥
        echo "ğŸ¯ ç›´æ¥æœç´¢ï¼Œä¸æèŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿"
        export SEARCH_DELAY=5
        export MAX_WORKERS=2
        export RETRY_DELAY=15
        
        # ç»™è¶³æ—¶é—´è®©æœç´¢å®Œæˆ
        timeout 1800 python run_processor.py || {
          echo "âŒ æœç´¢å¤±è´¥ï¼ŒGitHub Actionsç¯å¢ƒè¢«æ‹‰é»‘"
          echo "ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨æœ¬åœ°ç¯å¢ƒæˆ–è‡ªæ‰˜ç®¡Runneræ‰§è¡Œæœç´¢"
          exit 1
        }
        
        echo "âœ… æœç´¢é˜¶æ®µå®Œæˆ"
    
    - name: æ£€æŸ¥ç»“æœæ–‡ä»¶å¹¶éªŒè¯è´¨é‡
      id: check_result
      run: |
        if [ ! -f result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        if [ ! -s result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        line_count=$(wc -l < result.txt)
        file_size=$(du -h result.txt | cut -f1)
        group_count=$(grep -c "^[^,]*,$" result.txt 2>/dev/null || echo "0")
        
        # è®¡ç®—æœ‰æ•ˆé¢‘é“é“¾æ¥æ•°ï¼ˆæ’é™¤åˆ†ç»„æ ‡é¢˜è¡Œï¼‰
        valid_channel_count=$(grep -v "^[^,]*,$" result.txt | wc -l 2>/dev/null || echo "0")
        
        # ç¡®ä¿å˜é‡å€¼ä¸ä¸ºç©º
        line_count=${line_count:-0}
        file_size=${file_size:-"0B"}
        group_count=${group_count:-0}
        valid_channel_count=${valid_channel_count:-0}
        
        echo "ğŸ“Š ç»“æœç»Ÿè®¡: æ€»è¡Œæ•°=$line_count, æ–‡ä»¶å¤§å°=$file_size, åˆ†ç»„æ•°=$group_count, æœ‰æ•ˆé¢‘é“=$valid_channel_count"
        
        # è´¨é‡æ£€æŸ¥æ ‡å‡†
        MIN_CHANNELS=10  # æœ€å°‘10ä¸ªæœ‰æ•ˆé¢‘é“å°±è¡Œ
        MIN_GROUPS=2     # æœ€å°‘2ä¸ªåˆ†ç»„
        
        echo "ğŸ” è´¨é‡æ£€æŸ¥æ ‡å‡†ï¼ˆé™ä½è¦æ±‚ï¼‰"
        
        echo "ğŸ” è´¨é‡æ£€æŸ¥..."
        echo "- æœ‰æ•ˆé¢‘é“æ•°: $valid_channel_count (æœ€ä½è¦æ±‚: $MIN_CHANNELS)"
        echo "- åˆ†ç»„æ•°: $group_count (æœ€ä½è¦æ±‚: $MIN_GROUPS)"
        
        # æ£€æŸ¥æ˜¯å¦æ»¡è¶³æœ€ä½è¦æ±‚
        if [ "$valid_channel_count" -lt "$MIN_CHANNELS" ]; then
          echo "âŒ æœ‰æ•ˆé¢‘é“æ•°ä¸è¶³ ($valid_channel_count < $MIN_CHANNELS)ï¼Œè·³è¿‡æäº¤"
          echo "QUALITY_CHECK=false" >> $GITHUB_ENV
          exit 0
        fi
        
        if [ "$group_count" -lt "$MIN_GROUPS" ]; then
          echo "âŒ åˆ†ç»„æ•°ä¸è¶³ ($group_count < $MIN_GROUPS)ï¼Œè·³è¿‡æäº¤"
          echo "QUALITY_CHECK=false" >> $GITHUB_ENV
          exit 0
        fi
        
        echo "âœ… è´¨é‡æ£€æŸ¥é€šè¿‡"
        echo "QUALITY_CHECK=true" >> $GITHUB_ENV
        echo "VALID_CHANNELS=$valid_channel_count" >> $GITHUB_ENV
        echo "GROUPS=$group_count" >> $GITHUB_ENV
    
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      if: env.QUALITY_CHECK == 'true'
      run: |
        has_changes="false"
        if [ ! -f result_backup.txt ]; then
          echo "â„¹ï¸ é¦–æ¬¡è¿è¡Œ"
          has_changes="true"
        else
          if ! cmp -s result.txt result_backup.txt; then
            echo "ğŸ”„ æ–‡ä»¶æœ‰å˜åŒ–"
            has_changes="true"
          else
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–"
          fi
        fi
        echo "HAS_CHANGES=$has_changes" >> $GITHUB_ENV
    
    - name: é…ç½®Git
      if: env.QUALITY_CHECK == 'true' && env.HAS_CHANGES == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: æäº¤æ›´æ–°
      if: env.QUALITY_CHECK == 'true' && env.HAS_CHANGES == 'true'
      run: |
        cd ..
        git add Parser/result.txt
        current_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        # ä½¿ç”¨å·²éªŒè¯çš„ç»Ÿè®¡ä¿¡æ¯
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - $current_time" -m "âœ… è´¨é‡æ£€æŸ¥é€šè¿‡" -m "æœ‰æ•ˆé¢‘é“: ${VALID_CHANNELS} ä¸ª" -m "é¢‘é“åˆ†ç»„: ${GROUPS} ä¸ª"
        git push
        echo "âœ… æ›´æ–°å·²æäº¤"
    
    - name: è´¨é‡æ£€æŸ¥å¤±è´¥å¤„ç†
      if: env.QUALITY_CHECK == 'false'
      run: |
        echo "âš ï¸ æœ¬æ¬¡æ›´æ–°æœªæäº¤ï¼ŒåŸå› ï¼š"
        echo "- è§£æåˆ°çš„æœ‰æ•ˆé¢‘é“æ•°æˆ–åˆ†ç»„æ•°ä¸è¶³"
        echo "- å»ºè®®æ£€æŸ¥æœç´¢å™¨çŠ¶æ€æˆ–ç½‘ç»œè¿æ¥"
        echo "- ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡å°†é‡æ–°å°è¯•"
        exit 0

env:
  PYTHONIOENCODING: utf-8
  PYTHONUNBUFFERED: 1
