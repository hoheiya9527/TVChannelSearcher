name: è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨

# è§¦å‘æ¡ä»¶
on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©ä¸¤æ¬¡è‡ªåŠ¨æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00ï¼ˆåŒ—äº¬æ—¶é—´06:00ï¼‰
    - cron: '0 8 * * *'   # UTC 08:00ï¼ˆåŒ—äº¬æ—¶é—´16:00ï¼‰
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  push:
    branches: [ main ]
    paths: 
      - 'Parser/**'
      - '.github/workflows/**'

# å·¥ä½œæµä»»åŠ¡
jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œç›®å½•ä¸ºParseræ–‡ä»¶å¤¹
    defaults:
      run:
        working-directory: ./Parser
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # è®¾ç½®Pythonç¯å¢ƒ
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    # å®‰è£…Pythonä¾èµ–
    - name: ğŸ“¦ å®‰è£…ä¾èµ–åŒ…
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "âš ï¸ requirements.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤ä¾èµ–"
          pip install requests beautifulsoup4 lxml
        fi
    
    # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    - name: â„¹ï¸ æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ”§ Pythonç‰ˆæœ¬: $(python --version)"
        echo "ğŸ“¦ å·²å®‰è£…çš„åŒ…:"
        pip list
        echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
    
    # æ£€æŸ¥å¿…è¦æ–‡ä»¶
    - name: ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "ğŸ“‹ æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
        files=("LiveChannel.txt" "modular_batch_processor.py" "searcher_interface.py" "tonkiang_searcher.py" "run_processor.py")
        
        missing_files=()
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ… æ‰¾åˆ°æ–‡ä»¶: $file"
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "âŒ ç¼ºå°‘ä»¥ä¸‹æ–‡ä»¶:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        else
          echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶éƒ½å­˜åœ¨"
        fi
    
    # å¤‡ä»½åŸå§‹ç»“æœæ–‡ä»¶
    - name: ğŸ’¾ å¤‡ä»½åŸå§‹æ–‡ä»¶
      run: |
        if [ -f result.txt ]; then
          cp result.txt result_backup.txt
          echo "âœ… å·²å¤‡ä»½ result.txt"
          echo "ğŸ“Š åŸå§‹æ–‡ä»¶ç»Ÿè®¡:"
          wc -l result.txt || echo "æ— æ³•ç»Ÿè®¡è¡Œæ•°"
        else
          echo "â„¹ï¸ result.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
        fi
    
    # æ‰§è¡Œé¢‘é“æœç´¢
    - name: ğŸ” æ‰§è¡Œé¢‘é“æœç´¢
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œé¢‘é“æœç´¢..."
        echo "â° å¼€å§‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
        timeout 1800 python run_processor.py || {
          exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "â° æ‰§è¡Œè¶…æ—¶ï¼ˆ30åˆ†é’Ÿï¼‰ï¼Œå¯èƒ½ç½‘ç»œè¾ƒæ…¢æˆ–é¢‘é“è¿‡å¤š"
          else
            echo "âŒ æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
          fi
          exit $exit_code
        }
        
        echo "âœ… æœç´¢å®Œæˆ"
        echo "â° å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
    
    # æ£€æŸ¥ç»“æœæ–‡ä»¶
    - name: ğŸ“Š æ£€æŸ¥ç»“æœæ–‡ä»¶
      id: check_result
      run: |
        if [ ! -f result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [ ! -s result.txt ]; then
          echo "âŒ result.txt æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        # ç»Ÿè®¡ä¿¡æ¯
        line_count=$(wc -l < result.txt)
        file_size=$(du -h result.txt | cut -f1)
        group_count=$(grep -c "^[^,]*,$" result.txt || echo "0")
        
        echo "ğŸ“Š ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ç»Ÿè®¡:"
        echo "- æ€»è¡Œæ•°: $line_count"
        echo "- æ–‡ä»¶å¤§å°: $file_size"
        echo "- é¢‘é“åˆ†ç»„: $group_count"
        
        # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "line_count=$line_count" >> $GITHUB_OUTPUT
        echo "file_size=$file_size" >> $GITHUB_OUTPUT
        echo "group_count=$group_count" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆé“¾æ¥
        if [ $line_count -lt 5 ]; then
          echo "âš ï¸ ç»“æœæ–‡ä»¶å†…å®¹è¾ƒå°‘ï¼Œå¯èƒ½æœç´¢æœªæˆåŠŸ"
        else
          echo "âœ… ç»“æœæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
        fi
    
    # æ¯”è¾ƒæ–‡ä»¶å˜åŒ–
    - name: ğŸ”„ æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      run: |
        has_changes="false"
        
        if [ ! -f result_backup.txt ]; then
          echo "â„¹ï¸ é¦–æ¬¡è¿è¡Œï¼Œæ²¡æœ‰å¤‡ä»½æ–‡ä»¶è¿›è¡Œæ¯”è¾ƒ"
          has_changes="true"
        else
          # æ¯”è¾ƒæ–‡ä»¶å†…å®¹ï¼ˆå¿½ç•¥æ—¶é—´æˆ³è¡Œï¼‰
          if ! diff -q <(grep -v "^æ›´æ–°æ—¶é—´" result.txt) <(grep -v "^æ›´æ–°æ—¶é—´" result_backup.txt) > /dev/null; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å†…å®¹å˜åŒ–"
            
            # æ˜¾ç¤ºå˜åŒ–ç»Ÿè®¡
            old_lines=$(wc -l < result_backup.txt)
            new_lines=$(wc -l < result.txt)
            echo "ğŸ“Š å˜åŒ–ç»Ÿè®¡:"
            echo "- åŸå§‹è¡Œæ•°: $old_lines"
            echo "- æ–°çš„è¡Œæ•°: $new_lines"
            echo "- å˜åŒ–é‡: $((new_lines - old_lines))"
            
            has_changes="true"
          else
            echo "â„¹ï¸ æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
        fi
        
        echo "has_changes=$has_changes" >> $GITHUB_OUTPUT
    
    # é…ç½®Gitç”¨æˆ·
    - name: âš™ï¸ é…ç½®Gitç”¨æˆ·
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    # æäº¤æ›´æ–°
    - name: ğŸ“¤ æäº¤æ›´æ–°
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
        cd ..
        
        # æ·»åŠ æ›´æ–°çš„æ–‡ä»¶
        git add Parser/result.txt
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        current_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        beijing_time=$(date -d "+8 hours" '+%Y-%m-%d %H:%M:%S CST')
        
        commit_message="ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - $current_time

ğŸ“Š æ›´æ–°ç»Ÿè®¡:
- é¢‘é“åˆ†ç»„: ${{ steps.check_result.outputs.group_count }} ä¸ª  
- æ€»é“¾æ¥æ•°: ${{ steps.check_result.outputs.line_count }} è¡Œ
- æ–‡ä»¶å¤§å°: ${{ steps.check_result.outputs.file_size }}
- æ›´æ–°æ—¶é—´: $current_time
- åŒ—äº¬æ—¶é—´: $beijing_time

ğŸ¤– æ­¤æäº¤ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"
        
        echo "ğŸ“ æäº¤ä¿¡æ¯:"
        echo "$commit_message"
        
        git commit -m "$commit_message"
        git push
        
        echo "âœ… æ›´æ–°å·²æˆåŠŸæäº¤åˆ°ä»“åº“"
    
    # å·¥ä½œæµæ‘˜è¦
    - name: ğŸ“‹ ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ¯ IPTVé¢‘é“æœç´¢æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
        
        if [ -f result.txt ]; then
          echo "- âœ… **çŠ¶æ€**: æ‰§è¡ŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“º **é¢‘é“åˆ†ç»„**: ${{ steps.check_result.outputs.group_count }} ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **æ€»é“¾æ¥æ•°**: ${{ steps.check_result.outputs.line_count }} è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ’¾ **æ–‡ä»¶å¤§å°**: ${{ steps.check_result.outputs.file_size }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- ğŸ”„ **æ›´æ–°çŠ¶æ€**: å·²æäº¤æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ **æ›´æ–°çŠ¶æ€**: å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- âŒ **çŠ¶æ€**: æ‰§è¡Œå¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â° æ‰§è¡Œæ—¶é—´" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ• **UTCæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ• **åŒ—äº¬æ—¶é—´**: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— å¿«é€Ÿé“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ [æŸ¥çœ‹result.txt](./Parser/result.txt)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“œ [æŸ¥çœ‹æ‰§è¡Œå†å²](./commits)" >> $GITHUB_STEP_SUMMARY
        echo "- âš™ï¸ [å·¥ä½œæµè®¾ç½®](./.github/workflows/auto-update-channels.yml)" >> $GITHUB_STEP_SUMMARY

# ç¯å¢ƒå˜é‡
env:
  PYTHONIOENCODING: utf-8
  PYTHONUNBUFFERED: 1
