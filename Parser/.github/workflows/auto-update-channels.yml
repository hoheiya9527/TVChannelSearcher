name: è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨

on:
  # å®šæ—¶æ‰§è¡Œ - æ¯å¤©åŒ—äº¬æ—¶é—´06:00å’Œ16:00æ‰§è¡Œ
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 (åŒ—äº¬æ—¶é—´06:00)
    - cron: '0 8 * * *'   # UTC 08:00 (åŒ—äº¬æ—¶é—´16:00)
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # ä»£ç æ¨é€æ—¶ä¹Ÿå¯ä»¥è§¦å‘ï¼ˆå¯é€‰ï¼‰
  # push:
  #   branches: [ main ]

jobs:
  update-channels:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        # éœ€è¦å®Œæ•´çš„gitå†å²æ¥è¿›è¡Œæäº¤
        fetch-depth: 0
        # ä½¿ç”¨GitHub Tokenç¡®ä¿æœ‰æäº¤æƒé™
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # è®¾ç½®Pythonç¯å¢ƒ
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    # å®‰è£…ä¾èµ–
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–åŒ…..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # æ£€æŸ¥è¾“å…¥æ–‡ä»¶
    - name: æ£€æŸ¥è¾“å…¥æ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥è¾“å…¥æ–‡ä»¶..."
        if [ ! -f "LiveChannel.txt" ] && [ ! -f "livechannel.txt" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è¾“å…¥æ–‡ä»¶ LiveChannel.txt æˆ– livechannel.txt"
          exit 1
        fi
        
        if [ -f "LiveChannel.txt" ]; then
          echo "âœ… æ‰¾åˆ°è¾“å…¥æ–‡ä»¶ï¼šLiveChannel.txt"
          wc -l LiveChannel.txt
        elif [ -f "livechannel.txt" ]; then
          echo "âœ… æ‰¾åˆ°è¾“å…¥æ–‡ä»¶ï¼šlivechannel.txt"
          wc -l livechannel.txt
        fi
    
    # æ‰§è¡Œé¢‘é“æœç´¢
    - name: æ‰§è¡ŒIPTVé¢‘é“æœç´¢
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡ŒIPTVé¢‘é“æœç´¢..."
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "âœ¨ ç‰¹è‰²åŠŸèƒ½: æ™ºèƒ½éªŒè¯ + åŸŸåé¢‘ç‡æ’åº + è‡ªåŠ¨æ—¶é—´æˆ³"
        echo "ğŸ“ æ–°åŠŸèƒ½: è‡ªåŠ¨åœ¨ç¬¬ä¸€ä¸ªé¢‘é“å‰æ·»åŠ æ›´æ–°æ—¶é—´é¢‘é“"
        echo ""
        
        # æ‰§è¡Œä¸»ç¨‹åº
        python modular_batch_processor.py
        
        echo "â° ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        if [ -f "result.txt" ]; then
          echo "âœ… æœç´¢å®Œæˆï¼Œç”Ÿæˆç»“æœæ–‡ä»¶ result.txt"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h result.txt | cut -f1)"
          echo "ğŸ“Š é“¾æ¥æ•°é‡: $(grep -c ',' result.txt || echo '0')"
          
          # æ˜¾ç¤ºç»“æœæ–‡ä»¶çš„å‰10è¡Œä½œä¸ºé¢„è§ˆ
          echo "ğŸ“– ç»“æœé¢„è§ˆï¼ˆå‰10è¡Œï¼‰:"
          head -10 result.txt
        else
          echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆç»“æœæ–‡ä»¶ result.txt"
          exit 1
        fi
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
    - name: æ£€æŸ¥æ–‡ä»¶å˜åŒ–
      id: check_changes
      run: |
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–..."
        
        # æ£€æŸ¥gitçŠ¶æ€
        git status --porcelain
        
        # å¦‚æœresult.txtæœ‰å˜åŒ–
        if [ -n "$(git status --porcelain result.txt 2>/dev/null)" ]; then
          echo "âœ… result.txt æœ‰æ›´æ–°"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºå˜åŒ–çš„ç»Ÿè®¡ä¿¡æ¯
          if [ -f "result.txt" ]; then
            echo "ğŸ“Š æ›´æ–°åçš„ç»Ÿè®¡ä¿¡æ¯:"
            echo "  - æ–‡ä»¶å¤§å°: $(du -h result.txt | cut -f1)"
            echo "  - æ€»è¡Œæ•°: $(wc -l < result.txt)"
            echo "  - é“¾æ¥æ•°é‡: $(grep -c 'http' result.txt || echo '0')"
            echo "  - é¢‘é“åˆ†ç»„: $(grep -c '#genre#' result.txt || echo '0')"
          fi
        else
          echo "â„¹ï¸  result.txt æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    # æäº¤æ›´æ–°
    - name: æäº¤æ›´æ–°çš„é¢‘é“åˆ—è¡¨
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸ’¾ æäº¤æ›´æ–°çš„é¢‘é“åˆ—è¡¨..."
        
        # é…ç½®gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ å¹¶æäº¤å˜åŒ–
        git add result.txt
        
        # è·å–å½“å‰æ—¶é—´ç”¨äºæäº¤ä¿¡æ¯
        current_time=$(date '+%Y-%m-%d %H:%M:%S UTC')
        commit_message="ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVé¢‘é“åˆ—è¡¨ - ${current_time}"
        
        # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯åˆ°æäº¤æ¶ˆæ¯
        if [ -f "result.txt" ]; then
          link_count=$(grep -c 'http' result.txt || echo '0')
          group_count=$(grep -c '#genre#' result.txt || echo '0')
          commit_message="${commit_message}

ğŸ“Š æ›´æ–°ç»Ÿè®¡:
- é¢‘é“åˆ†ç»„: ${group_count} ä¸ª  
- æœ‰æ•ˆé“¾æ¥: ${link_count} ä¸ª
- æ–‡ä»¶å¤§å°: $(du -h result.txt | cut -f1)
- æ›´æ–°æ—¶é—´: ${current_time}"
        fi
        
        git commit -m "${commit_message}"
        
        echo "âœ… æäº¤å®Œæˆ"
    
    # æ¨é€åˆ°è¿œç¨‹ä»“åº“
    - name: æ¨é€åˆ°GitHubä»“åº“
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "ğŸš€ æ¨é€åˆ°GitHubä»“åº“..."
        git push
        echo "âœ… æ¨é€å®Œæˆ"
    
    # ä»»åŠ¡å®Œæˆé€šçŸ¥
    - name: ä»»åŠ¡å®Œæˆé€šçŸ¥
      if: always()
      run: |
        echo "==================== ä»»åŠ¡æ‰§è¡Œå®Œæˆ ===================="
        echo "ğŸ“… æ‰§è¡Œæ—¥æœŸ: $(date '+%Y-%m-%d')"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date '+%H:%M:%S UTC')"
        echo "ğŸ”„ æ‰§è¡ŒçŠ¶æ€: ${{ job.status }}"
        
        if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… çŠ¶æ€: é¢‘é“åˆ—è¡¨å·²æ›´æ–°å¹¶æäº¤"
          if [ -f "result.txt" ]; then
            echo "ğŸ“Š æœ€ç»ˆç»Ÿè®¡:"
            echo "  - é“¾æ¥æ•°é‡: $(grep -c 'http' result.txt || echo '0')"
            echo "  - é¢‘é“åˆ†ç»„: $(grep -c '#genre#' result.txt || echo '0')"
          fi
        else
          echo "â„¹ï¸  çŠ¶æ€: é¢‘é“åˆ—è¡¨æ— å˜åŒ–ï¼Œæœªæ‰§è¡Œæäº¤"
        fi
        echo "=================================================="

    # é”™è¯¯å¤„ç†å’Œæ¸…ç†ï¼ˆå¯é€‰ï¼‰
    - name: é”™è¯¯å¤„ç†å’Œæ¸…ç†
      if: failure()
      run: |
        echo "âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿›è¡Œé”™è¯¯å¤„ç†..."
        
        # æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        echo "ğŸ“‹ å½“å‰ç›®å½•æ–‡ä»¶:"
        ls -la
        
        # æ˜¾ç¤ºgitçŠ¶æ€
        echo "ğŸ“‹ GitçŠ¶æ€:"
        git status
        
        # å¦‚æœæœ‰éƒ¨åˆ†ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ï¼Œæ˜¾ç¤ºå…¶å†…å®¹
        if [ -f "result.txt" ]; then
          echo "ğŸ“‹ éƒ¨åˆ†ç»“æœæ–‡ä»¶å†…å®¹:"
          head -20 result.txt
        fi
        
        echo "ğŸ’¡ è¯·æ£€æŸ¥æ—¥å¿—ä»¥äº†è§£å¤±è´¥åŸå› "
